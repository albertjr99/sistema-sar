<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Central de Estatísticas - SAR</title>

  <!-- CSS / Ícones -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>

  <!-- Chart.js (gráficos desta página) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    .chart-container {
      position: relative;
      height: 400px;
      margin-bottom: 2rem;
    }
    .stats-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }
    .stats-number {
      font-size: 2.5rem;
      font-weight: bold;
    }
    .sidebar {
      background: #f8f9fa;
      min-height: 100vh;
      padding: 1rem;
    }
    .nav-link {
      color: #333;
      border-radius: 10px;
      margin-bottom: 0.5rem;
    }
    .nav-link.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .nav-link:hover {
      background: #e9ecef;
      color: #333;
    }
    .nav-link.active:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
  </style>
</head>

<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-2 sidebar">
        <div class="text-center mb-4">
          <h4><i class="fas fa-building"></i> SAR</h4>
          <small>Sistema de Arrecadação</small>
        </div>

        <div class="mb-3">
          <small class="text-muted">Logado como:</small><br/>
          <strong>Erica</strong><br/>
          <small class="text-muted">Gerente</small>
        </div>

        <nav class="nav flex-column">
          <a class="nav-link" href="/painel-gerencia">
            <i class="fas fa-tachometer-alt"></i> Painel Gerência
          </a>
          <a class="nav-link active" href="/central-estatisticas">
            <i class="fas fa-chart-line"></i> Central Estatísticas
          </a>
          <a class="nav-link" href="/logout">
            <i class="fas fa-sign-out-alt"></i> Sair
          </a>
        </nav>
      </div>

      <!-- Main Content -->
      <div class="col-md-10">
        <div class="container-fluid py-4">
          <!-- Header -->
          <div class="row mb-4">
            <div class="col-12">
              <h1><i class="fas fa-chart-line"></i> Central de Estatísticas</h1>
              <p class="text-muted">Relatórios e análises em tempo real</p>
            </div>
          </div>

          <!-- Filtros -->
          <div class="row mb-4">
            <div class="col-md-12">
              <div class="card">
                <div class="card-body">
                  <h5><i class="fas fa-filter"></i> Filtros</h5>
                  <div class="row">
                    <div class="col-md-3">
                      <label for="periodo" class="form-label">Período</label>
                      <select class="form-select" id="periodo" onchange="toggleDataPersonalizada()">
                        <option value="hoje">Hoje</option>
                        <option value="semana" selected>Última Semana</option>
                        <option value="mes">Este Mês</option>
                        <option value="trimestre">Trimestre</option>
                        <option value="ano">Este Ano</option>
                        <option value="historico">Todo o Histórico</option>
                        <option value="personalizado">Data Personalizada</option>
                      </select>
                    </div>

                    <div class="col-md-6" id="dataPersonalizada" style="display:none;">
                      <div class="row">
                        <div class="col-md-6">
                          <label for="dataInicio" class="form-label">Data Início</label>
                          <input type="date" class="form-control" id="dataInicio"/>
                        </div>
                        <div class="col-md-6">
                          <label for="dataFim" class="form-label">Data Fim</label>
                          <input type="date" class="form-control" id="dataFim"/>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-3">
                      <label for="analista" class="form-label">Analista</label>
                      <select class="form-select" id="analista">
                        <option value="">Todos</option>
                        <option value="Alessandro">Alessandro</option>
                        <option value="Bruno">Bruno</option>
                        <option value="Carmen">Carmen</option>
                        <option value="Vanessa">Vanessa</option>
                        <option value="Zenilda">Zenilda</option>
                      </select>
                    </div>

                    <div class="col-md-12 mt-3">
                      <button class="btn btn-primary me-2" onclick="carregarEstatisticas()">
                        <i class="fas fa-sync-alt"></i> Atualizar
                      </button>
                      <button class="btn btn-success" onclick="exportarRelatorio()">
                        <i class="fas fa-file-download"></i> Exportar Relatório
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Cards de Resumo -->
          <div class="row mb-4" id="resumoCards">
            <div class="col-md-4">
              <div class="stats-card text-center">
                <div class="stats-number" id="totalProcessos">0</div>
                <div>Total de Processos</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="stats-card text-center">
                <div class="stats-number" id="totalConcluidos">0</div>
                <div>Concluídos</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="stats-card text-center">
                <div class="stats-number" id="totalAndamento">0</div>
                <div>Em Andamento</div>
              </div>
            </div>
          </div>

          <!-- Gráficos -->
          <div class="row">
            <div class="col-md-6 mb-4">
              <div class="card">
                <div class="card-header">
                  <h5><i class="fas fa-chart-line"></i> Evolução Temporal</h5>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="graficoEvolucao"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card">
                <div class="card-header">
                  <h5><i class="fas fa-chart-pie"></i> Status dos Processos</h5>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="graficoStatus"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-md-12 mb-4">
              <div class="card">
                <div class="card-header">
                  <h5><i class="fas fa-chart-bar"></i> Produtividade por Analista</h5>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="graficoAnalistas"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-md-12 mb-4">
              <div class="card">
                <div class="card-header">
                  <h5><i class="fas fa-table"></i> Relatório Detalhado de Produtividade</h5>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-striped table-hover" id="tabelaProdutividade">
                      <thead class="table-dark">
                        <tr>
                          <th>Analista</th>
                          <th>Total Processos</th>
                          <th>Concluídos</th>
                          <th>Em Andamento</th>
                          <th>Aguardando Orientação</th>
                          <th>Aguardando Chamado</th>
                          <th>Sobrestado</th>
                          <th>% Conclusão</th>
                          <th>Performance</th>
                        </tr>
                      </thead>
                      <tbody id="corpoTabelaProdutividade">
                        <tr>
                          <td colspan="9" class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin"></i> Carregando dados...
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Loading indicator -->
          <div id="loading" class="text-center" style="display:none;">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-2">Carregando estatísticas...</p>
          </div>

          <!-- Error message -->
          <div id="error" class="alert alert-danger" style="display:none;">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="errorMessage">Erro ao carregar estatísticas</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- JavaScript da página -->
  <script>
    // Exibe/oculta datas personalizadas
    function toggleDataPersonalizada() {
      const periodo = document.getElementById('periodo').value;
      document.getElementById('dataPersonalizada').style.display =
        periodo === 'personalizado' ? 'block' : 'none';
    }

    let graficoEvolucaoChart = null;
    let graficoStatusChart = null;
    let graficoAnalistasChart = null;
    let dadosEstatisticas = null;

    function carregarEstatisticas() {
      const periodo = document.getElementById('periodo').value;
      const analista = document.getElementById('analista').value;
      const dataInicio = document.getElementById('dataInicio').value;
      const dataFim = document.getElementById('dataFim').value;

      document.getElementById('loading').style.display = 'block';
      document.getElementById('error').style.display = 'none';

      const params = new URLSearchParams({ periodo });
      if (analista) params.append('analista', analista);
      if (periodo === 'personalizado') {
        if (dataInicio) params.append('data_inicio', dataInicio);
        if (dataFim) params.append('data_fim', dataFim);
      }

      fetch('/sar/api/estatisticas-tempo-real?' + params.toString())
        .then(r => r.json())
        .then(data => {
          document.getElementById('loading').style.display = 'none';
          if (data.success) {
            dadosEstatisticas = data.estatisticas;
            atualizarCards(dadosEstatisticas);
            atualizarGraficoEvolucao(dadosEstatisticas.evolucao || {});
            atualizarGraficoStatus(dadosEstatisticas.status || {});
            atualizarGraficoAnalistas(dadosEstatisticas.por_analista_detalhado || {});
            atualizarTabelaProdutividade(dadosEstatisticas.por_analista_detalhado || {});
          } else {
            mostrarErro(data.message || 'Erro ao carregar estatísticas');
          }
        })
        .catch(err => {
          document.getElementById('loading').style.display = 'none';
          mostrarErro('Erro de conexão: ' + err.message);
        });
    }

    function mostrarErro(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('error').style.display = 'block';
    }

    function atualizarCards(est) {
      let total = 0, concluidos = 0, andamento = 0;
      if (est.por_analista_detalhado) {
        Object.values(est.por_analista_detalhado).forEach(a => {
          total += a.total || 0;
          concluidos += a.concluidos || 0;
          andamento += a.em_andamento || 0;
        });
      }
      document.getElementById('totalProcessos').textContent = total;
      document.getElementById('totalConcluidos').textContent = concluidos;
      document.getElementById('totalAndamento').textContent = andamento;
    }

    function atualizarGraficoEvolucao(evolucao) {
      if (graficoEvolucaoChart) graficoEvolucaoChart.destroy();
      graficoEvolucaoChart = new Chart(document.getElementById('graficoEvolucao'), {
        type: 'line',
        data: {
          labels: Object.keys(evolucao),
          datasets: [{
            label: 'Processos por dia',
            data: Object.values(evolucao),
            borderColor: '#4e79a7',
            fill: false
          }]
        }
      });
    }

    function atualizarGraficoStatus(statusData) {
      if (graficoStatusChart) graficoStatusChart.destroy();
      graficoStatusChart = new Chart(document.getElementById('graficoStatus'), {
        type: 'pie',
        data: {
          labels: Object.keys(statusData),
          datasets: [{
            data: Object.values(statusData),
            backgroundColor: ['#27ae60','#e67e22','#3498db','#ff851b','#ff9f40','#dc3545']
          }]
        }
      });
    }

    function atualizarGraficoAnalistas(analistasData) {
      if (graficoAnalistasChart) graficoAnalistasChart.destroy();
      const labels = Object.keys(analistasData);
      const valores = labels.map(a => (analistasData[a] && analistasData[a].total) ? analistasData[a].total : 0);
      graficoAnalistasChart = new Chart(document.getElementById('graficoAnalistas'), {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Total de Processos',
            data: valores,
            backgroundColor: '#764ba2'
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    function atualizarTabelaProdutividade(analistasData) {
      const tbody = document.getElementById('corpoTabelaProdutividade');
      tbody.innerHTML = '';
      Object.entries(analistasData).forEach(([nome, d]) => {
        tbody.innerHTML += `
          <tr>
            <td><strong>${nome}</strong></td>
            <td><span class="badge bg-primary">${d.total}</span></td>
            <td><span class="badge bg-success">${d.concluidos}</span></td>
            <td><span class="badge bg-warning text-dark">${d.em_andamento}</span></td>
            <td><span class="badge bg-info text-dark">${d.aguardando_orientacao || 0}</span></td>
            <td><span class="badge bg-secondary">${d.aguardando_chamado || 0}</span></td>
            <td><span class="badge bg-dark">${d.sobrestado || 0}</span></td>
            <td><strong>${d.percentual || 0}%</strong></td>
            <td class="fw-bold">${d.percentual>=97?'Excelente':(d.percentual>=95?'Acima da Média':'Abaixo da Média')}</td>
          </tr>`;
      });
    }

    // ==============================
    // Exportar Relatório (HTML externo com Google Charts)
    // ==============================
    function exportarRelatorio() {
      if (!dadosEstatisticas) {
        alert('Carregue as estatísticas primeiro antes de exportar o relatório.');
        return;
      }

      const est = dadosEstatisticas;

      const analistasDetalhe = est.por_analista_detalhado || {};
      const graficoAnalistas = Object.keys(analistasDetalhe)
        .map(a => `['${a}', ${analistasDetalhe[a].total || 0}]`)
        .join(',\n');

      const statusData = est.status || {};
      const graficoStatus = Object.entries(statusData)
        .map(([k,v]) => `['${k}', ${v}]`)
        .join(',\n');

      const evolucaoData = est.evolucao || {};
      const graficoEvolucao = Object.entries(evolucaoData)
        .map(([d,v]) => `['${d}', ${v}]`)
        .join(',\n');

      let linhasTabela = '';
      Object.keys(analistasDetalhe).forEach(a => {
        const d = analistasDetalhe[a];
        const perf = d.percentual >= 97 ? 'Excelente' : d.percentual >= 95 ? 'Acima da Média' : 'Abaixo da Média';
        const cls  = d.percentual >= 97 ? 'badge-ok'  : d.percentual >= 95 ? 'badge-mid'      : 'badge-low';
        linhasTabela += `
          <tr>
            <td>${a}</td>
            <td>${d.total}</td>
            <td>${d.concluidos}</td>
            <td>${d.em_andamento}</td>
            <td>${d.aguardando_orientacao || 0}</td>
            <td>${d.aguardando_chamado || 0}</td>
            <td>${d.sobrestado || 0}</td>
            <td>${d.percentual || 0}</td>
            <td><span class="badge ${cls}">${perf}</span></td>
          </tr>`;
      });

      // IMPORTANTE: usar <\/script> para não encerrar o <script> externo
      const htmlRelatorio = `
<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8"/>
<title>Relatório Gerencial - SAR</title>
<script src="https://www.gstatic.com/charts/loader.js"><\/script>
<style>
  body { font-family: Arial, sans-serif; margin:20px; }
  h1 { margin-top:0; }
  .section { margin-bottom:35px; }
  .chart-box { height:320px; margin-bottom:25px; }
  table { border-collapse:collapse; width:100%; }
  th, td { border:1px solid #ccc; padding:6px 8px; font-size:13px; text-align:center; }
  th { background:#222; color:#fff; }
  .badge { padding:2px 6px; border-radius:4px; font-size:11px; }
  .badge-ok { background:#198754; color:#fff; }
  .badge-mid { background:#ffc107; }
  .badge-low { background:#dc3545; color:#fff; }
</style>
</head>
<body>
<h1>Relatório Gerencial de Produtividade</h1>
<p>Gerado em: ${new Date().toLocaleString()}</p>

<div class="section">
  <h2>Gráficos</h2>
  <div id="graficoAnalistas" class="chart-box"></div>
  <div id="graficoStatus" class="chart-box"></div>
  <div id="graficoEvolucao" class="chart-box"></div>
</div>

<div class="section">
  <h2>Tabela de Produtividade</h2>
  <table>
    <thead>
      <tr>
        <th>Analista</th>
        <th>Total</th>
        <th>Concluídos</th>
        <th>Em Andamento</th>
        <th>Aguard. Orientação</th>
        <th>Aguard. Chamado</th>
        <th>Sobrestado</th>
        <th>%</th>
        <th>Performance</th>
      </tr>
    </thead>
    <tbody>
      ${linhasTabela}
    </tbody>
  </table>
</div>

<script>
  // Google Charts
  google.charts.load('current', {packages:['corechart']});
  google.charts.setOnLoadCallback(drawCharts);

  function drawCharts() {
    var dataAnalistas = google.visualization.arrayToDataTable([
      ['Analista', 'Total'],
      ${graficoAnalistas || "['(Sem dados)', 0]"}
    ]);
    new google.visualization.ColumnChart(document.getElementById('graficoAnalistas'))
      .draw(dataAnalistas, {title: 'Produtividade por Analista', legend: {position: 'none'}});

    var dataStatus = google.visualization.arrayToDataTable([
      ['Status', 'Total'],
      ${graficoStatus || "['(Sem dados)', 0]"}
    ]);
    new google.visualization.PieChart(document.getElementById('graficoStatus'))
      .draw(dataStatus, {title: 'Status dos Processos'});

    var dataEvolucao = google.visualization.arrayToDataTable([
      ['Data', 'Qtd'],
      ${graficoEvolucao || "['(Sem dados)', 0]"}
    ]);
    new google.visualization.LineChart(document.getElementById('graficoEvolucao'))
      .draw(dataEvolucao, {title: 'Evolução Diária', curveType: 'function'});
  }
<\/script>
</body>
</html>`;

      const blob = new Blob([htmlRelatorio], { type: 'text/html' });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href = url;
      a.download = 'relatorio_gerencial.html';
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
